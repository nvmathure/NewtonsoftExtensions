trigger:
  - master

pr:
 branches:
   include:
     - master

variables:
  solutionFile : '$(Build.SourcesDirectory)\Src\NewtonsoftExtensions.sln'
  configuration: 'release'

pool:
  vmImage: 'windows-latest'

steps:
- task: SonarCloudPrepare@1
  inputs:
    SonarCloud: 'SonarCloud-CloudNDevOps'
    organization: 'cloudndevops'
    scannerMode: 'MSBuild'
    projectKey: 'Newtonsoft.Extensions'
    projectName: 'Newtonsoft.Extensions'
    extraProperties: 'sonar.cs.vscoveragexml.reportsPaths = $(Build.SourceDirectory)\**\*.coverage'

- task: DotNetCoreCLI@2
  displayName: Restore NuGet Packages
  inputs:
    command: restore
    projects: $(solutionFile)

- task: DotNetCoreCLI@2
  displayName: Build Solution
  inputs:
    command: build
    projects: $(solutionFile)
    configuration: $(configuration)
    arguments: --no-restore

- task: DotNetCoreCLI@2
  displayName: Execute Test Cases
  inputs:
    command: test
    projects: $(solutionFile)
    arguments: --no-build --collect:"Code Coverage"

- task: SonarCloudAnalyze@1
  displayName: SonarQube Analysis

- task: SonarCloudPublish@1
  displayName: Publish to SonarCloud

- task: NuGetAuthenticate@0
  displayName: Authenticate to NuGet.Org
  inputs:
    nuGetServiceConnections: 'NuGet - CloudNDevOps.Newtonsoft.Extensions'
    forceReinstallCredentialProvider: true
